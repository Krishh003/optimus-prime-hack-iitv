{% extends 'listings/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'listings/css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid chat-container">
    <div class="row h-100">
        <!-- Chat Sidebar -->
        <div class="col-md-3 chat-sidebar">
            <div class="chat-header">
                <h4 class="mb-0">Chat Details</h4>
            </div>
            <div class="chat-info">
                <div class="other-party-info">
                    <div class="avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h5>{{ other_party.name }}</h5>
                </div>
                <hr>
                <div class="chat-actions">
                    <a href="{% url 'my_requests' %}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to Requests
                    </a>
                </div>
            </div>
        </div>

        <!-- Chat Main Content -->
        <div class="col-md-9 chat-main">
            <div class="chat-messages" id="chatMessages">
                {% for message in messages %}
                <div class="message {% if message.sender.id|stringformat:'s' == user_id %}message-sent{% else %}message-received{% endif %}" data-message-id="{{ message.id }}">
                    <div class="message-content">
                        <div class="message-text">{{ message.message }}</div>
                        <div class="message-meta">
                            <span class="message-time">{{ message.created_at|date:"g:i A" }}</span>
                            <span class="message-date">{{ message.created_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="chat-input">
                <form id="messageForm" class="message-form">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    let isPolling = true;
    
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        chatMessages.appendChild(errorDiv);
        scrollToBottom();
    }
    
    scrollToBottom();
    
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        fetch(`/api/chat/{{ request_id }}/send/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                if (data.error.includes('no longer valid') || data.error.includes('permission')) {
                    isPolling = false;
                    window.location.href = "{% url 'my_requests' %}";
                }
            } else {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-sent';
                messageDiv.dataset.messageId = data.id;
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${data.message}</div>
                        <div class="message-meta">
                            <span class="message-time">${new Date(data.created_at).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</span>
                            <span class="message-date">${new Date(data.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
                messageInput.value = '';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('An error occurred while sending the message.');
        });
    });
    
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    function pollMessages() {
        if (!isPolling) return;
        
        fetch(`/api/chat/{{ request_id }}/messages/`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to fetch messages');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    if (data.error.includes('no longer valid') || 
                        data.error.includes('permission') || 
                        data.error.includes('not found') ||
                        data.error.includes('Invalid request ID')) {
                        isPolling = false;
                        window.location.href = "{% url 'my_requests' %}";
                    }
                    return;
                }
                
                const currentMessageIds = new Set(
                    Array.from(chatMessages.children)
                        .filter(el => el.classList.contains('message'))
                        .map(el => el.dataset.messageId)
                );
                
                let hasNewMessages = false;
                data.forEach(message => {
                    if (!currentMessageIds.has(message.id)) {
                        hasNewMessages = true;
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${message.sender.id === '{{ user_id }}' ? 'message-sent' : 'message-received'}`;
                        messageDiv.dataset.messageId = message.id;
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <div class="message-text">${message.message}</div>
                                <div class="message-meta">
                                    <span class="message-time">${new Date(message.created_at).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</span>
                                    <span class="message-date">${new Date(message.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                            </div>
                        `;
                        chatMessages.appendChild(messageDiv);
                    }
                });
                
                if (hasNewMessages) {
                    scrollToBottom();
                }
            })
            .catch(error => {
                console.error('Error polling messages:', error);
                showError(error.message || 'An error occurred while fetching messages.');
                if (error.message.includes('no longer valid') || 
                    error.message.includes('permission') || 
                    error.message.includes('not found') ||
                    error.message.includes('Invalid request ID')) {
                    isPolling = false;
                    window.location.href = "{% url 'my_requests' %}";
                }
            });
    }
    
    pollMessages();
    setInterval(pollMessages, 3000);
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}